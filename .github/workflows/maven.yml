name: CI Gradual - Passo 2 (Build + Staging)

on: [push, workflow_dispatch]

jobs:
  # === JOB 1: CONSTRUIR (Igual ao anterior, mas salva o arquivo no final) ===
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # Compila e roda testes unit√°rios
      - name: Maven Build
        run: mvn clean package -DargLine="-Dheadless=true"

      # --- A NOVIDADE COME√áA AQUI ---
      # Salva o arquivo .jar gerado para usar no pr√≥ximo job
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  # === JOB 2: STAGING (Baixa o arquivo e tenta rodar) ===
  staging:
    name: üß™ Staging
    needs: build # S√≥ come√ßa se o Build der certo
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Precisamos do c√≥digo para rodar o Selenium depois
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Baixa o arquivo que o Job 1 salvou
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/

      # Tenta subir a aplica√ß√£o (Deploy Simulado)
      - name: Start App
        run: |
          nohup java -jar target/*.jar > staging.log 2>&1 &
          echo "Aplica√ß√£o iniciando... aguardando 15s..."
          sleep 15

      # Roda o teste de interface contra a aplica√ß√£o rodando
      - name: Teste P√≥s-Deploy (Selenium)
        run: mvn test -Dtest=ProductInterfaceTest -DargLine="-Dheadless=true -DtargetUrl=http://localhost:8080"