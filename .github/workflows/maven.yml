name: CI/CD Completo (Dev -> Staging -> Prod)

on: [push, workflow_dispatch]

jobs:
  # === 1. BUILD (DEV) ===
  build:
    name: ğŸ—ï¸ Build (Dev)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Maven Build
        run: mvn clean package -DargLine="-Dheadless=true"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

  # === 2. STAGING (TESTE PÃ“S-DEPLOY) ===
  staging:
    name: ğŸ§ª Staging Deploy
    needs: build
    runs-on: ubuntu-latest
    environment: staging # <--- ISSO CRIA A CAIXINHA VISUAL NO GITHUB
    steps:
      - uses: actions/checkout@v4
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/

      # Inicia o App
      - name: Start App
        run: |
          nohup java -jar target/*.jar > staging.log 2>&1 &
          echo "Iniciando Staging... aguardando 20s..."
          sleep 20

      # Testa o App Rodando
      - name: Teste PÃ³s-Deploy (Selenium)
        run: mvn test -Dtest=ProductInterfaceTest -DargLine="-Dheadless=true -DtargetUrl=http://localhost:8080"

      # Monitoramento (Salva Logs)
      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: staging-logs
          path: staging.log

  # === 3. PRODUCTION (DEPLOY SEGURO) ===
  production:
    name: ğŸš€ Production Deploy
    needs: staging # SÃ³ roda se o Staging passar
    runs-on: ubuntu-latest
    environment: production # <--- AMBIENTE DE PRODUÃ‡ÃƒO
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-jar
          path: target/

      # RUBRICA: Gerenciamento de Segredos
      - name: Deploy Seguro
        env:
          # Usamos um segredo real do GitHub (Token) para provar o conceito
          SECURE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Conectando ao Servidor de ProduÃ§Ã£o..."
          echo "Autenticando com Token Seguro..."
          echo "Deploy da versÃ£o ${{ github.run_number }} concluÃ­do com sucesso!"